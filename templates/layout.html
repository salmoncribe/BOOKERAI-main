<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="theme-color" content="#0ea5e9" />
  <title>{% block title %}BookerAI{% endblock %}</title>

  <!-- Global Styles -->
  <!-- Global Styles (Modularized) -->
  <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}?v={{ asset_ver }}" /> -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v={{ asset_ver }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}?v={{ asset_ver }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}?v={{ asset_ver }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v={{ asset_ver }}" />

  <!-- Optional font + basic layout guard -->
  <style>
    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: "Poppins", system-ui, sans-serif;
      background: var(--bg-light, #f0faff);
      color: var(--text-dark, #0f172a);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    main {
      flex: 1;
    }
  </style>
  <style>
    html,
    body {
      height: auto !important;
      min-height: 100vh !important;
      overflow-y: auto !important;
      -webkit-overflow-scrolling: touch !important;
    }

    .v2,
    main,
    .dashboard {
      height: auto !important;
      min-height: 100vh !important;
      overflow: visible !important;
    }

    .animated-bg {
      position: fixed !important;
      inset: 0 !important;
      pointer-events: none !important;
    }
  </style>
  <style>
    /* Prevent FOUC if possible */
    html {
      visibility: visible;
      opacity: 1;
    }
  </style>
  <script>
    // Theme Init (Immediate)
    (function () {
      // STRICT: Only allow dark mode if explicitly permitted (Premium Logged In)
      // We inject a Python boolean here. If 'barber' is not defined (logged out) or not premium, this is false.
      const allowDarkMode = {{ 'true' if (barber is defined and barber.plan == 'premium') else 'false'
    }};
    const saved = localStorage.getItem("theme");

    if (allowDarkMode && saved === "dark") {
      document.documentElement.setAttribute("data-theme", "dark");
    } else {
      // Enforce light mode on unauthorized pages (Home, Login, Free Dash)
      document.documentElement.removeAttribute("data-theme");
    }
    }) ();

    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute("data-theme");
      const sun = document.querySelector(".sun-icon");
      const moon = document.querySelector(".moon-icon");

      if (current === "dark") {
        html.removeAttribute("data-theme");
        localStorage.setItem("theme", "light");
        if (sun) sun.style.display = "none";
        if (moon) moon.style.display = "block";
      } else {
        html.setAttribute("data-theme", "dark");
        localStorage.setItem("theme", "dark");
        if (sun) sun.style.display = "block";
        if (moon) moon.style.display = "none";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Sync Icon State
      const html = document.documentElement;
      const sun = document.querySelector(".sun-icon");
      const moon = document.querySelector(".moon-icon");
      if (html.getAttribute("data-theme") === "dark") {
        if (sun) sun.style.display = "block";
        if (moon) moon.style.display = "none";
      }
    });
  </script>

  {% block head %}{% endblock %}
</head>

<body>
  <!-- =======================
         HEADER (outside .v2)
    ======================== -->
  <header class="site-header" role="banner">
    <div class="nav-wrap">
      <!-- Back Button: HIDDEN on Dashboard/Home; AUTH PAGES force Home; OTHERS use Smart History -->
      {% if request.endpoint not in ['dashboard', 'home', 'index'] %}
      {% if request.endpoint in ['login', 'signup', 'signup_free', 'signup_premium', 'forgot_password'] %}
      <button class="nav-back-btn" onclick="window.location.href='{{ url_for('home') }}'" aria-label="Go Home">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6" />
        </svg>
      </button>
      {% else %}
      <button class="nav-back-btn"
        data-home="{{ url_for('dashboard') if session.get('barberId') else url_for('home') }}"
        onclick="if(document.referrer && document.referrer.indexOf(location.host) !== -1) { history.back(); } else { window.location.href = this.dataset.home; }"
        aria-label="Go Back">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6" />
        </svg>
      </button>
      {% endif %}
      {% endif %}

      <!-- Logo -->
      <a class="logo" href="javascript:void(0)" onclick="window.location.reload()" aria-label="BookerAI Home">
        <span class="logo-dot"></span>
        <span>BookerAI</span>
      </a>

      <!-- Theme Toggle -->
      <!-- Theme Toggle: ONLY for Premium Users -->
      {% if barber is defined and barber.plan == 'premium' %}
      <button class="theme-toggle" aria-label="Toggle Theme" onclick="toggleTheme()"
        style="margin-left: auto; margin-right: 1rem; background:none; border:none; cursor:pointer; color: var(--text-main); display:flex; align-items:center;">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
          <circle cx="12" cy="12" r="5" />
          <path d="M12 1v2" />
          <path d="M12 21v2" />
          <path d="M4.22 4.22l1.42 1.42" />
          <path d="M18.36 18.36l1.42 1.42" />
          <path d="M1 12h2" />
          <path d="M21 12h2" />
          <path d="M4.22 19.78l1.42-1.42" />
          <path d="M18.36 5.64l1.42-1.42" />
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
        </svg>
      </button>
      {% else %}
      <!-- Spacer if no toggle, pushes nav right -->
      <div style="margin-left: auto;"></div>
      {% endif %}

      <!-- Hamburger Button -->
      <!-- Remove margin-left auto if it exists on hamburger since theme toggle took it, or keep layout flex -->
      <button class="hamburger" aria-label="Toggle navigation" aria-expanded="false" style="margin-left:0;">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <!-- Navigation -->
      <nav class="nav-links" role="navigation" aria-label="Main navigation">
        <div class="nav-content-wrap" style="width: 100%; display: flex; flex-direction: column; flex: 1;">
          <div class="nav-identity">
            {% if session.get('barberId') %}
            <div class="user-info">
              <div class="avatar-circle">
                {% if session.get('user_email') %}
                {{ session.get('user_email')[0]|upper }}
                {% else %}
                B
                {% endif %}
              </div>
              <div class="user-text">
                <span class="user-greeting-label">Hello,</span>
                <span class="user-name">{{ session.get('barber_name', 'Barber') }}</span>
              </div>
            </div>
            {% endif %}
          </div>

          {% if session.get('barberId') %}
          <div class="nav-primary">
            <a href="{{ url_for('dashboard') }}"
              class="nav-link primary-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
              <span class="icon">üìä</span> Dashboard
            </a>
            <a href="{{ url_for('profile', barber_id=session.get('barberId')) }}"
              class="nav-link primary-link {% if request.endpoint == 'profile' %}active{% endif %}">
              <span class="icon">üåé</span> Public Profile
            </a>
            <a href="{{ url_for('results', service='Barber') }}"
              class="nav-link primary-link {% if request.endpoint in ['results', 'find_pro_route'] %}active{% endif %}">
              <span class="icon">üîç</span> Find a Pro
            </a>
          </div>

          <div class="nav-secondary">
            <a href="{{ url_for('help_center') }}"
              class="nav-link secondary-link {% if request.endpoint == 'help_center' %}active{% endif %}">Help</a>
            <a href="{{ url_for('cancel_page') }}"
              class="nav-link secondary-link {% if request.endpoint == 'cancel_page' %}active{% endif %}"
              style="color: #ef4444; opacity: 0.8; font-size: 0.95rem; margin-top: 5px;">
              Cancel Subscription
            </a>
          </div>

          <div class="nav-special">
            <a href="{{ url_for('subscribe') }}" class="nav-link pulse-gold premium-btn">
              Upgrade to Premium <span class="gem">üíé</span>
            </a>
          </div>

          <div class="nav-bottom">
            <div class="nav-divider"></div>
            <a href="{{ url_for('logout') }}" class="nav-link logout-link">Log Out</a>
          </div>
          {% else %}
          <!-- Guest Nav -->
          <div class="nav-guest">
            <div class="nav-primary">
              <a href="{{ url_for('home') }}"
                class="nav-link primary-link {% if request.endpoint in ['home', 'index'] %}active{% endif %}">
                <span class="icon">üè†</span> Home
              </a>
              <a href="{{ url_for('results', service='Barber') }}"
                class="nav-link primary-link {% if request.endpoint in ['results', 'find_pro_route'] %}active{% endif %}">
                <span class="icon">üîç</span> Find a Pro
              </a>
              <a href="{{ url_for('demo') }}"
                class="nav-link primary-link {% if request.endpoint == 'demo' %}active{% endif %}">
                <span class="icon">üöÄ</span> Live Demo
              </a>
            </div>

            <div class="nav-divider"></div>

            <div class="nav-secondary">
              <a href="{{ url_for('login') }}"
                class="nav-link secondary-link {% if request.endpoint == 'login' %}active{% endif %}"
                style="justify-content: flex-start; gap: 1rem;">
                <span class="icon" style="display:inline-block; width:24px; text-align:center;">üîê</span> Log In
              </a>
            </div>

            <div class="nav-special" style="margin-top: 1.5rem;">
              <a href="{{ url_for('signup') }}" class="nav-link btn-primary gradient-btn text-white shadow-lg"
                style="justify-content: center; border-radius: 12px; font-weight: 700; padding: 1rem; text-align: center;">
                Get Started Free <span style="margin-left:8px">‚Üí</span>
              </a>
            </div>
          </div>
          {% endif %}
        </div>
      </nav>
    </div>
  </header>

  <!-- =======================
         MAIN APP WRAPPER (.v2)
    ======================== -->
  <div class="v2">
    <main id="main" class="site-main" role="main" tabindex="-1"
      style="max-width:1200px;margin:auto;padding:0;width:100%;">
      {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
      <div class="flash-stack" role="status" aria-live="polite">
        {% for cat, msg in messages %}
        <div class="alert {{ cat }}"
          style="margin-bottom:0.5rem;padding:0.75rem 1rem;background:#e0f7ff;border-left:4px solid #0ea5e9;border-radius:0.5rem;">
          <span>{{ msg }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- =======================
         FOOTER
    ======================== -->
  <footer class="site-footer" role="contentinfo"
    style="background:#f0faff;border-top:1px solid rgba(14,165,233,0.2);padding:1rem 0;text-align:center;color:#0f172a;font-size:0.9rem;">
    ¬© 2025 BookerAI ¬∑ All rights reserved

  </footer>

  <!-- =======================
         SCRIPTS
    ======================== -->
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Global Mobile Nav Logic
    document.addEventListener('DOMContentLoaded', () => {
      const ham = document.querySelector('.hamburger');
      const nav = document.querySelector('.nav-links');

      if (ham && nav) {
        ham.addEventListener('click', (e) => {
          e.stopPropagation();
          const expanded = ham.getAttribute('aria-expanded') === 'true';
          ham.setAttribute('aria-expanded', !expanded);
          ham.classList.toggle('active');
          nav.classList.toggle('active');
        });

        // Close on link click
        nav.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
            ham.setAttribute('aria-expanded', 'false');
            ham.classList.remove('active');
            nav.classList.remove('active');
          });
        });

        // Close on click outside
        document.addEventListener('click', (e) => {
          if (nav.classList.contains('active') && !nav.contains(e.target) && !ham.contains(e.target)) {
            ham.setAttribute('aria-expanded', 'false');
            ham.classList.remove('active');
            nav.classList.remove('active');
          }
        });
      }
    });
  </script>
  {% block scripts %}{% endblock %}
  <div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const lucideScript = document.querySelector('script[src*="lucide"]');

      // Global Copy Link
      document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('.copy-global-btn');
        if (btn) {
          const url = btn.dataset.copyUrl;
          if (url) {
            navigator.clipboard.writeText(url).then(() => {
              // Simple feedback
              const original = btn.innerHTML;
              btn.innerHTML = `‚úì Copied`;
              btn.classList.add('copied-state');
              setTimeout(() => {
                btn.innerHTML = original;
                btn.classList.remove('copied-state');
                if (window.lucide) window.lucide.createIcons();
              }, 2000);

              // Also show a toast?
              showToast("Link copied to clipboard!");
            });
          }
        }
      });

      function showToast(msg) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast show';
        // Reuse existing toast style from dashboard.css if available, 
        // but layout.css might not have it. I'll stick to btn feedback mainly.
        // If toast class doesn't exist globally, this div is just unstyled text.
        // I'll skip toast reliance and stick to button text change.
      }
    });
  </script>
</body>

</html>