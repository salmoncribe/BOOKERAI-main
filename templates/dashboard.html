{% extends "layout.html" %}
{% block title %}Dashboard â€” BookerAI{% endblock %}

{% block content %}
{% set public_link = url_for('book_view', barber_id=barber.id, _external=True) %}

<section class="dashboard vibrant-auth {% if barber.plan == 'premium' %}premium-theme{% endif %}" id="dashboardRoot"
  data-barber-id="{{ barber.id }}">

  <div class="animated-bg"></div>

  <!-- Header Section -->
  <div class="dash-head">
    {% if barber.plan == 'premium' %}
    <div class="premium-bubble" title="Premium Active"></div>
    {% endif %}

    <div style="display:flex;align-items:center;gap:1rem;">
      <!-- Avatar Upload -->
      <form id="photoForm" action="{{ url_for('upload_photo') }}" method="POST" enctype="multipart/form-data"
        style="display:inline-block;">
        <label for="photoInput" style="cursor:pointer;display:inline-block;">
          {% if barber.photo_url %}
          <div style="width:60px;height:60px;border-radius:50%;overflow:hidden;flex-shrink:0;position:relative;">
            <img src="{{ barber.photo_url }}" alt="{{ barber.name }}"
              style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
            <div style="position:absolute;bottom:0;right:0;width:22px;height:22px;
                          background:linear-gradient(135deg,var(--sky-blue),var(--teal));
                          border-radius:50%;display:flex;align-items:center;justify-content:center;
                          color:#fff;font-size:0.75rem;">
              ðŸ“·
            </div>
          </div>
          {% else %}
          <div style="width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;
                        background:linear-gradient(135deg,var(--sky-blue),var(--teal));color:#fff;font-weight:600;
                        font-size:1.25rem;flex-shrink:0;">
            {{ (barber.name or 'B')[:1] | upper }}
          </div>
          {% endif %}
        </label>
        <input id="photoInput" name="photo" type="file" accept="image/*" style="display:none;"
          onchange="document.getElementById('photoForm').submit();">
      </form>

      <!-- Text -->
      <div>
        <h1 class="dash-title">
          Welcome, {{ barber.name|default('Barber') }}
        </h1>
        <p class="muted small">Manage your hours and appointments below.</p>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <!-- Main Content -->
    <div class="main-content">
      <!-- Upcoming Appointments -->
      <div class="card appointments-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <h3>Upcoming Appointments</h3>
          <button class="btn btn-secondary small" onclick="openCalendar()">View Calendar</button>
        </div>
        {% if appointments %}
        <div class="table-scroll">
          <table class="table">
            <thead>
              <tr>
                <th>Client</th>
                <th>Phone</th>
                <th>When</th>
              </tr>
            </thead>
            <tbody>
              {% for a in appointments %}
              <tr>
                <td>{{ a.client_name or "Unknown" }}</td>
                <td>
                  <a href="tel:{{ a.client_phone }}">{{ a.client_phone }}</a>
                </td>
                <td>{{ a.date }} {{ a.start_time }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="muted small">No upcoming appointments yet.</p>
        {% endif %}
      </div>

      <!-- Business Hours -->
      <div class="card hours-card">
        <div class="hours-header" style="flex-direction:column; gap:0.5rem; margin-bottom:1rem;">
          <h3>Business Hours</h3>
          <p class="muted small" style="margin:0;">
            Set your availability so clients can book you online.
          </p>
        </div>

        <div style="text-align:center; margin-bottom:1rem;">
          <button id="toggleHoursBtn" class="btn btn-secondary small">
            Edit Hours
          </button>
        </div>

        <!-- Collapsible Editor -->
        <div id="hoursCollapse" class="hours-collapse">
          <div style="text-align:center; margin-bottom:1rem;">
            <button id="copyMonday" class="copy-all">Copy Monday â†’ All Days</button>
          </div>

          <div class="hours-list">
            {% for d in ["mon","tue","wed","thu","fri","sat","sun"] %}
            <div class="hours-row" data-day="{{ d }}">
              <div class="day-label">{{ d|capitalize }}</div>
              <div class="day-actions">
                <label class="toggle-switch">
                  <input type="checkbox" class="day-toggle-input" checked>
                  <span class="slider"></span>
                </label>
                <div class="time-range">
                  <input type="time" class="open-time" value="09:00">
                  <span>to</span>
                  <input type="time" class="close-time" value="17:00">
                </div>
                <div class="save-check">âœ…</div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-sticky">
      <!-- Action buttons -->
      <div class="card">
        <h3>Quick Actions</h3>
        <div class="dash-actions" style="flex-direction:column;align-items:stretch;">
          <button id="copyLinkBtn" type="button" class="btn-primary gradient-btn small" data-copy="{{ public_link }}">
            Copy booking link
          </button>
          <a class="btn btn-secondary small" href="{{ public_link }}" target="_blank" rel="noopener"
            style="text-align:center;">
            Open public page
          </a>
        </div>
      </div>

      <!-- ðŸ–¼ï¸ Media Upload Section -->
      <div class="card media-card">
        <h3>Upload Media</h3>
        <p class="muted small">Show off your work â€” upload photos or videos directly to your profile gallery.</p>
        <form id="mediaForm" action="{{ url_for('upload_media') }}" method="POST" enctype="multipart/form-data"
          style="margin-top:1rem;">
          <input type="file" id="mediaInput" name="file" accept="image/*,video/*" style="display:none;"
            onchange="document.getElementById('mediaForm').submit();">
          <button type="button" class="gradient-btn small" style="width:100%;"
            onclick="document.getElementById('mediaInput').click();">
            ðŸ“¤ Upload File
          </button>
        </form>
        <div id="mediaStatus" class="muted small" style="margin-top:0.5rem;"></div>
        <div id="mediaGallery" class="media-gallery" style="margin-top:1rem;display:flex;flex-wrap:wrap;gap:0.75rem;">
        </div>
      </div>
    </div>
  </div>

  </div>

  <!-- Calendar Modal -->
  <div id="calendarModal" class="calendar-modal">
    <div class="calendar-content">
      <div class="calendar-header">
        <h2>Schedule</h2>
        <button class="close-modal-btn" onclick="closeCalendar()">Ã—</button>
      </div>
      <div id="calendarGrid" class="cal-grid">
        <!-- JS will populate -->
      </div>
    </div>
  </div>

</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}